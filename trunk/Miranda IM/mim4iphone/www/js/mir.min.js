$(function(){function q(y){if(!y){return""}return $("<div />").text(y).html()}setInterval(function(){$(".msg-ts").each(function(){var y=$(this).attr("rel");if(y){$(this).html(d(parseInt(y)))}})},5000);function d(B){var A=new Date(B).getTime();var y=new Date();var z=y.getTime();var C=Math.round((z-A)/1000);var D="";switch(true){case (C==0):C="";D="";break;case (C<60):D="second";break;case (C<60*59):C=Math.round(C/60);D="minute";break;case (C<60*60*24):C=Math.round(C/60/60);D="hour";break;case (C<60*60*24*30):C=Math.round(C/60/60/24);D="day";break;default:C=new Date(B).toUTCString();D="";break}D=C+" "+D+(C>0&&C!=1?"s":"")+(C>0?" ago":"");return'<span class="msg-ts" rel="'+B+'">'+D+"</span>"}function i(){var A=document.getElementById("cltoolbartop").offsetHeight,z=document.getElementById("cltoolbar").offsetHeight,y=window.innerHeight-A-z;document.getElementById("wrapper").style.height=y+1+"px"}var u=new iScroll("wrapper",{hScrollbar:false,});var b;function t(){b=new Date().getTime()}function r(){return new Date().getTime()-b>1000*60}function g(z,y){var A=$("<audio />").get(0);$(A).attr("src","../sounds/"+z).bind("loadstart",function(){A.play()});A.load()}t();window.addEventListener("onorientationchange" in window?"orientationchange":"resize",i,false);document.addEventListener("touchmove",function(y){y.preventDefault()},false);$("body").bind("mousemove touchmove click",function(y){t()});mUI={};getchatui(mUI);function k(){setTimeout(function(){u.refresh()},50)}function j(){var y=$("#sview").children(":last-child").get(0);if(y.offsetTop>$("#wrapper").height()){u.scrollToElement(y)}}function p(z){var A;switch(z.type){case"msg":A=mUI.onMsgIncoming(z);break;case"selfmsg":A=mUI.onMsgOutgoing(z);break;case"status":A=mUI.onMsgStatus(z);break;default:A="<p>event ("+z.type+") unhandled.</p>"}var y=$(A);$(".msg-text",y).click(function(){});$(y).appendTo("#msg");return y}function w(y){var z=$("#_0 .cl-self-avatar-"+y);if(!z.length){z=$("#_0 .cl-self-avatar-")}return z}function n(y,z){$("#cltitle").text(y.nickname);x("#msg",function(){$("#msg").html("").data("activeContact",y.hContact);$("#wrapper").addClass("ajaxload");A(0,true);function B(C){a={cid:y.hContact,eid:C,chain:1};$.get("/api/msg/markread",a,function(E,D){})}function A(D,C){getargs={cid:y.hContact,preview:"1",self:C?1:0};$.get("/api/msg/unread",getargs,function(I,E){$("#wrapper").removeClass("ajaxload");var K=$(".cl-contact-icon-avatar",z).attr("src");var L=w(y.proto).attr("src");var H={message:"",ts:""};var G=0;var F;var J=$(I).find("item[cid='"+y.hContact+"']");$(J).find("event").each(function(){G=$(this).attr("eid");if(G>D){H.message=q($(this).text());H.unread=$(this).attr("unread")?true:false;H.ts=d($(this).attr("ts")*1000);H.type=q($(this).attr("type"));H.avatar=(H.type=="msg")?K:L;F=p(H);k()}});if(F){k();setTimeout(function(){j()},750)}if(C){$("#sendmsg").show()}setTimeout(function(){if(!$("#msg").is(":visible")){return}if(G){B(G)}A(G,false)},5000)})}})}function s(y,z){args={cid:y,msg:z};$.get("/api/msg/send",args,function(B,A){},"xml")}function v(){function B(C){m={cid:$("#msg").data("activeContact"),stop:C?0:1};$.get("/api/notify/typing",m,function(E,D){})}args={};args.message="<input text='text' id='cl-send-area' />";args.unread=false;args.ts="";args.hideavatar=true;var A=mUI.onMsgOutgoing(args);var z=$(A);$(z).appendTo("#sendmsg");var y;$("#cl-send-area").bind("keyup",function(C){if(y){clearTimeout(y);y=null}else{B(true)}y=setTimeout(function(){y=null;B(false)},5000)}).change(function(F){if(!$("#msg").is(":visible")){return}if(y){clearTimeout(y);y=null}var C=$("#msg").data("activeContact");var D=jQuery.trim($(this).val());if(D.length<1){return}s(C,D);cData=$("#_"+C).data("cData");args.message=q(D);args.ts=d(new Date().getTime());args.avatar=w(cData.proto).attr("src");var E=mUI.onMsgOutgoing(args);$(E).appendTo("#msg");k();setTimeout(function(){j()},500);$(this).val("");F.preventDefault()})}function e(){var D;if(!D){$.get("/api/clist",function(I,H){D=I;z(I);B();E();setInterval(y,1000*10);setInterval(B,1000*5);setInterval(E,1000*60*2)},"xml")}else{z(D)}var G;function A(H){$("#cl").children().sort(function(L,J){var I=$(L).data("cData");var P=$(J).data("cData");if(!I||!P){return I?1:-1}function K(){return P.unread-I.unread}function O(){if(I.unick==P.unick){return 0}return I.unick>P.unick?1:-1}function N(){if(I.statusw==P.statusw){return 0}return I.statusw<P.statusw?1:-1}var M;M=K();if(M!=0){return M}M=N();if(M!=0){return M}M=O();return M}).prependTo("#cl");G=null}function F(H){if(G){clearTimeout(G);G=null}G=setTimeout(function(){A(H)},250)}var C=1;function y(){$.get("/api/clist",function(K,I){var H=false;var J;$(K).find("item").each(function(){var O={hContact:q($(this).attr("cid")),nickname:q($(this).text()),status:q($(this).attr("status")),statusw:q($(this).attr("statusw")),proto:q($(this).attr("proto")),};O.unick=O.nickname.toLowerCase();var L=$("#_"+O.hContact);cData=$(L).data("cData");if(cData.status!=O.status){$(".cl-contact-icon",L).removeClass("cl-icon-"+cData.proto+"-"+cData.status).addClass("cl-icon-"+O.proto+"-"+O.status);$(".cl-contact-text",L).removeClass("cl-contact-text-"+cData.status).addClass("cl-contact-text-"+O.status);$(".cl-contact-status",L).text(O.status).attr("weight",O.statusw);var N=$("#msg");var M=$(N).data("activeContact");if($(N).is(":visible")&&M==O.hContact){args.type="status";args.message=O.nickname+" is "+O.status;p(args)}H=true}if(cData.nickname!=O.nickname){$(".cl-contact-text",L).text(O.nickname);H=true}for(f in O){cData[f]=O[f]}$(L).data("cData",cData)});if(H){F("contact")}},"xml")}function E(){$.get("/api/contact/avatar",function(I,H){$(I).find("item").each(function(){var K={hContact:q($(this).attr("cid")),proto:q($(this).attr("proto"))};if(K.hContact>0){var L=$("#_"+K.hContact+" .cl-contact-icon-avatar");$(L).attr("src","/api/contact/avatar?cid="+K.hContact).show()}else{var J=w(K.proto);if(!J.length){J=$("<img>");$(J).addClass("cl-self-avatar-"+K.proto);$(J).appendTo("#_0")}$(J).attr("src","/api/contact/avatar?cid=0&proto="+K.proto)}})},"xml")}function B(){$.get("/api/msg/unread",function(K,I){var H=false;var M=false;$(".cl-contact-unread:visible").addClass("inactivebadge");var J=$("#msg:visible").data("activeContact");var N=0;$(K).find("item").each(function(){var Q={hContact:q($(this).attr("cid")),unread:q($(this).find("unread").text())};var R=$("#_"+Q.hContact+" .cl-contact-unread");var O=$(R).parent();var P=$(O).data("cData");if(Q.unread!=P.unread){H=true}if(Q.unread>P.unread&&(J!=Q.hContact||idleUser())){M=true}$(R).removeClass("inactivebadge").text(Q.unread).show();for(f in Q){P[f]=Q[f]}$(O).data("cData",P);if(J&&J!=Q.hContact||!J&&!$("#cl").is(":visible")){N+=parseInt(Q.unread)}});if(N>0){$("#cl-other-events").text(N).show("fade")}if(M){g("message.mp3",0)}var L=$(".inactivebadge");if(L.length){H=true}$(L).hide().removeClass("inactivebadge").text(0);if(H){F("unread")}},"xml")}function z(H){$(H).find("item").each(function(){var L={hContact:q($(this).attr("cid")),nickname:q($(this).text()),status:q($(this).attr("status")),statusw:q($(this).attr("statusw")),proto:q($(this).attr("proto")),unread:0};L.unick=L.nickname.toLowerCase();var P=$("<div />").attr("id","_"+L.hContact).addClass("cl-contact").data("cData",L);var M=$("<img>").hide().addClass("cl-contact-icon-avatar");var N=$("<img />").addClass("cl-contact-icon cl-icon-"+L.proto+"-"+L.status).attr("src","images/1x1.png").click(function(){n(L,P)});var O=$("<span>"+L.nickname+"</span>").addClass("cl-contact-text cl-contact-text-"+L.status).click(function(){n(L,P)});var K=$("<span>0</span>").addClass("cl-contact-unread").hide().click(function(){n(L,P)});var J=$("<span>"+L.status+"</span>").addClass("cl-contact-status").attr("weight",L.statusw).hide();$(P).append(N).append(O).append(K).append(J).append(M).appendTo("#cl")});var I=$("<div />").attr("id","_0").addClass("cl-contact-self").hide();$(I).appendTo("#cl");F("init");i();k()}}$(".acc-status-combo").live("change",function(y){a={acid:$(this).data("acid"),setstatus:$(this).val(),};$.get("/api/account",a,function(A,z){})});function c(){$("#wrapper").addClass("ajaxload pinbackground");$("#acc").children().remove();function y(E,O,C){var H=0;var P=1;var K=2;var I=4;var J=8;var B=16;var G=32;var z=64;var M=128;var L=256;var A=[H,P,K,I,J,B,G,z,M,L];var N=["offline","online","invisible","away","na","occupied","dnd","freechat","outtolunch","onthephone"];var F=["Offline","Online","Invisible","Away","N/A","Occupied","DND","Free for chat","Out to lunch","On the phone"];var D='<select class="acc-status-combo" data-status="'+E+'" data-acid="'+C+'">';D+="<option "+(E=="offline"?"selected":"")+'value="offline">Offline</option>';$(A).each(function(R){if(this&O){var Q=N[R];D+="<option "+(E==Q?"selected":"")+' value="'+Q+'">'+F[R]+"</option>"}});return D+"</select>"}$.get("/api/account",function(A,z){$(A).find("item").each(function(){var F=$(this).attr("acid");var G=$("<div />").addClass("acc-win");var C=$("<label />");$(C).text(F.toLowerCase()).appendTo(G);var E=$(this).attr("status");var D=$(this).attr("status_mask");var B=y(E,D,F);sHTML='<table class="acc-table">';sHTML+="<thead></thead>";sHTML+="<tbody>";sHTML+='<tr><td class="acc-table-field">status</td> <td class="acc-table-fieldvalue">'+B+"</td></tr>";sHTML+="</tbody></table>";$(G).append(sHTML).appendTo("#acc")});k();$("#wrapper").removeClass("ajaxload")})}e();v();var l="#cl";function o(y){switch(y){case"#cl":$("#cl-other-events").hide("fade");case"#acc":if(y=="#acc"){c()}$("#cltitle").text("Miranda IM");$("#sendmsg").hide();break;case"#msg":break}}function h(y){switch(y){case"#acc":$("#wrapper").removeClass("pinbackground");break}}function x(z,y){if(l==z){return false}if(y){y()}$(l).hide(0,function(){h(l);o(z);$(z).show();l=z;k();$("#cltoolbar li.active").removeClass("active");$('#cltoolbar li[rel="'+l+'"]').addClass("active")});return true}$("#cltoolbartop").click(function(){u.scrollTo(0,0,"150ms")});$("#cltoolbar > ul > li").click(function(){x($(this).attr("rel"))})});
